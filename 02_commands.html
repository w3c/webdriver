<section>
  <h2>Communication between the local end and the remote end</h2>
  <section>
    <h3>The JSON Wire Protocol</h3>
    <p>When the Local End and the Remote End communicate with each other they MUST do so via HTTP. When describing the URL to use for each <code>Command</code> this specification will use URI paths encoded using the scheme described in [[!URI-TEMPLATE]]. The following substitutions are commonly made:</p>

      <dl>
        <dt>{sessionId}</dt>
        <dd>The <code>sessionId</code> of the selected session.</dd>

        <dt>{ELEMENT}</dt>
        <dd>The unique identifier of the <code>WebElement</code> instance being referred to</dd>
      </dl>

    <p>The URLs given in this specification MUST have the same path prefix. Implementations are free to redirect those as necessary.</p>

    <p class="note">The reason for doing this is to reduce the complexity of local-end implementations. They need only append the path to a base URL in order to create a working implementation.</p>

    <section>
      <h3>Handling HTTP requests and responses between the Remote End and Local End</h3>
      <p>When communicating between the local end and the remote end the following algorithm needs to be followed.</p>
      <ol>
        <li><a href="#receiving-http-requests">Receive HTTP request from the local end</a></li>
        <li><a href="#calling-webdriver-commands">Call the WebDriver command</a></li>
        <li><a href="#returning-http-response">Returning HTTP response to the local end</a></li>
      </ol>

      <h4 id='receiving-http-requests'>Receiving HTTP requests from the local end</h4>
      <p>When handling requests from the local end to the remote end we must do the following first and then follow the steps :
      <ol>
        <li>Let <var>sessionid</var> be the value in the {sessionId} section in the [[!URI-TEMPLATE]]</li>
        <li>if {ELEMENT} section in the [[!URI-TEMPLATE]] is populated let <var id='uri-template-element'>element</var> be equal to the {ELEMENT} section</li>
        <li>If the HTTP request is a POST let <var id='post-payload'>payload body</var> contain the
          <a href='http://www.ecma-international.org/ecma-262/5.1/#sec-15.12.2'>parsed JSON</a>
         in the payload body of the request.
          If <var>payload body</var> does not <a href='http://www.ecma-international.org/ecma-262/5.1/#sec-15.12.2'>parse into JSON</a> return a HTTP response with status code 500 and the payload body containing details of the parsing error if available.
        </li>
      </ol>

      <h4 id='calling-webdriver-commands'>Call the WebDriver command</h4>
      <p>When the HTTP request has been parsed a call to the underlying WebDriver Command using the following algorithm:</p>
      <ol>
        <li>Let <var>command</var> be the command that has the corresponding URI as described throughout this document</li>
        <li>Let <var>response</var> be an initially empty object with the following fields:</li>
          <ul>
            <li><var>status</var>, initially set to <a>success</a>.
            <li><var>value</var>, initially set to null.
          </ul>
        <li>If the <a>active session</a> is null
         and <var>command</var> is not <a href=#newsession>new session</a>, run these substeps:
          <ul>
            <li>Set <var>response</var>'s <var>status</var> field to <a>invalid sessionid</a>.
            <li>Return <var>response</var>.
          </ul>
        <li>Else if the <var>session ID</var> is not equal
         to the <a>active session</a>'s <a>session ID</a>, run these substeps:
          <ul>
            <li>Set <var>response</var>'s <var>status</var> field to <a>invalid sessionid</a>.
            <li>Return <var>response</var>.
          </ul>
        <li>If evaluating <var>command</var> yielded an error:
          <ul>
            <li>Set <var>response</var>'s <var>status</var> to
             the appropriate status code corresponding to the error,
             or <a>unknown error</a>.
            <li>Return <var>response</var>.
           </ul>
        <li>Let <var>response</var>'s <var>value</var> be the return value
         from the evaluated <var>command</var>.
        <li>Return <var>response</var>.
      </ol>

      <h4 id='returning-http-response'>Returning a HTTP response to the local end</h4>
      <p>when the command has completed encode the result using the following algorithm:</p>

      <ol>
        <li>Set the HTTP response status code to 200 unless described differently in the commands below</li>
        <li>Let <var>sessionId</var> be the unique identifier for the current session</li>
        <li>Add the contents of <var>result</var> to an object could be <a href='http://www.ecma-international.org/ecma-262/5.1/#sec-15.12.3'>stringified in to JSON</a>
        <li>Let the payload body of the response be the <a href='http://www.ecma-international.org/ecma-262/5.1/#sec-15.12.3'>stringified JSON</a>
          object.
          <ol>
            <li>If <a href="#newsession">newSession()</a> is called then the response payload body would look like the following
              <pre>
                {
                  "sessionId" : "string value",
                  "value" : capabilities-object,
                }.
              </pre>
            </li>
            <li>
              If the WebDriver Command has to return data it should be the whole of the response payload body and look like the following
              <pre>
                {
                  "value": "data from WebDriver Commands"
                }
              </pre>
            </li>
            <li>
              If the WebDriver Command results in an error then the response payload body would look like the following
              <pre>
                {
                  "status": "string value",
                  "value" : "string message"
                }
              </pre>
            </li>
          </ol>
        </li>
        <li>Set HTTP headers for the follow keys and their values.
          <ul>
            <li><code>cache-control: no-cache</code></li>
            <li><code>content-type: application/json</code></li>
          </ul>
        </li>
        <li>Return HTTP response to the Local End</li>
      </ol>
    </section>
  </section>
  <section>
    <h3>Status Codes</h3>
    <p>The WebDriver API indicates the success or failure of a command invocation via <var>status</var>. The following values are used and have the following meanings.</p>

    <table class="simple">
      <tr>
        <th>Status Code</th>
        <th>Detail</th>
      </tr>
      <tr>
        <td><dfn id="status-element-not-selectable">element not selectable</dfn></td>
        <td>An attempt was made to select an element that cannot be selected.</td>
      </tr>
      <tr>
        <td><dfn id="status-element-not-visible">element not visible</dfn></td>
        <td>An element command could not be completed because the element is not visible on the page.</td>
      </tr>
      <tr>
        <td><dfn id="status-invalid-argument">invalid argument</dfn></td>
        <td>The arguments passed to a command are either invalid or malformed.</td>
      </tr>
      <tr>
        <td><dfn id="status-invalid-cookie-domain">invalid cookie domain</dfn></td>
        <td>An illegal attempt was made to set a cookie under a different domain than the current page.</td>
      </tr>
      <tr>
        <td><dfn id="status-invalid-element-coordinates">invalid element coordinates</dfn></td>
        <td>The coordinates provided to an interactions operation are invalid.</td>
      </tr>
      <tr>
        <td><dfn id="status-invalid-element-state">invalid element state</dfn></td>
        <td>An element command could not be completed because the element is in an invalid state (e.g. attempting to click an element that is no longer attached to the Document).</td>
      </tr>
      <tr>
        <td><dfn id="status-invalid-selector">invalid selector</dfn></td>
        <td>Argument was an invalid selector (e.g. XPath/CSS).</td>
      </tr>
      <tr>
        <td><dfn id="status-invalid-sessionid">invalid sessionid</dfn></td>
        <td>The session with the session id does not exist. This could be either from the session being quit
         or the session id passed in is not currently active.</td>
      </tr>
      <tr>
        <td><dfn id="status-javascript-error">javascript error</dfn></td>
        <td>An error occurred while executing user supplied JavaScript.</td>
      </tr>
      <tr>
        <td><dfn id="status-move-target-out-of-bounds">move target out of bounds</dfn></td>
        <td>The target for mouse interaction is not in the browser's viewport and cannot be brought into that viewport.</td>
      </tr>
      <tr>
        <td><dfn id="status-no-such-alert">no such alert</dfn></td>
        <td>An attempt was made to operate on a modal dialog when one was not open.</td>
      </tr>
      <tr>
        <td><dfn id="status-no-such-element">no such element</dfn></td>
        <td>An element could not be located on the page using the given search parameters.</td>
      </tr>
      <tr>
        <td><dfn id="status-no-such-frame">no such frame</dfn></td>
        <td>A request to switch to a frame could not be satisfied because the frame could not be found.</td>
      </tr>
      <tr>
        <td><dfn id="status-no-such-window">no such window</dfn></td>
        <td>A request to switch to a different window could not be satisfied because the window could not be found.</td>
      </tr>
      <tr>
        <td><dfn id="status-script-timeout">script timeout</dfn></td>
        <td>A script did not complete before its timeout expired.</td>
      </tr>
      <tr>
        <td><dfn id="status-session-not-created">session not created</dfn></td>
        <td>A new session could not be created.</td>
      </tr>
      <tr>
        <td><dfn id="status-stale-element-reference">stale element reference</dfn></td>
        <td>An element command failed because the referenced element is no longer attached to the Document.</td>
      </tr>
      <tr>
        <td><dfn id="status-success">success</dfn></td>
        <td>The command executed successfully.</td>
      </tr>
      <tr>
        <td><dfn id="status-timeout">timeout</dfn></td>
        <td>An operation did not complete before its timeout expired.</td>
      </tr>
      <tr>
        <td><dfn id="status-unable-to-set-cookie">unable to set cookie</dfn></td>
        <td>A request to set a cookie's value could not be satisfied.</td>
      </tr>
      <tr>
        <td><dfn id="status-unexpected-alert-open">unexpected alert open</dfn></td>
        <td>A modal dialog was open, blocking this operation.</td>
      </tr>
      <tr>
        <td><dfn id="status-unknown-command">unknown command</dfn></td>
        <td>A command could not be executed because the remote end is not aware of it.</td>
      </tr>
      <tr>
        <td><dfn id="status-unknown-error">unknown error</dfn></td>
        <td>An unknown error occurred in the remote end while processing the command.</td>
      </tr>
      <tr>
        <td><dfn id="status-unsupported-operation">unsupported operation</dfn></td>
        <td>Indicates that a command that should have executed properly cannot be supported for some reason.</td>
      </tr>
    </table>
  </section>

  <section>
    <h2>Handling of Status Codes at the Local End</h2>

    <p>Status codes are returned from the <a href="#remote-end">remote end</a> to the <a href="#local-end">local end</a>. The <a href="#local-end">local end</a> SHOULD convert these into a form appropriate for the implementation language. For example, in C the status codes might be converted to constant integer values, whereas in Java various exceptions could be thrown.</p>

    <p>Implementations of the <a href="#local-end">local end</a> written in languages that support exceptions SHOULD make use of an exception hierarchy rooted on a <code>WebDriverException</code> (or similarly named base exception class). Where references to <code>WebDriverException</code> are made in this specification, we are referring to this local end conversion of status codes to local end exceptions.</p>

    <p class="note">The reason for this is to allow users of the local end to easily handle the all expected failure modes of a local WebDriver implementation by catching the <code>WebDriverException</code>.</p>

     <p class="note">It is strongly recommended that the <code>WebDriverException</code> contain as much diagnostic information as possible, including version numbers and details about the remote end. This is because experience suggests that when reporting errors from tests using WebDriver, users will simply cut-and-paste a stack trace of an exception. Adding this information to the exception makes the task of debugging problems considerably easier.</p>
  </section>

</section>
